<?php
session_start();
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// Include the database configuration file with a relative path
require_once __DIR__ . '/../config.php';

// Get the database connection
$conn = getDBConnection();

$search = $_GET['search'] ?? '';

// Inserted New Code

// Handle "Get Today's Reports" request
if (isset($_POST['report_today'])) {
    // Get the current date
    $currentDate = date('Y-m-d');

    // Modify the SQL query to filter by today's date
    $sql = "SELECT visitors.*, visit_reasons.reason_description, visiting_persons.person_name
            FROM visitors
            LEFT JOIN visit_reasons ON visitors.visit_reason_id = visit_reasons.reason_id
            LEFT JOIN visiting_persons ON visitors.visiting_person_id = visiting_persons.person_id
            WHERE CONCAT(visitors.first_name, ' ', visitors.last_name) LIKE ?
            AND DATE(checkin_time) = ?";
    
    $stmt = $conn->prepare($sql);
    $stmt->bind_param("ss", $searchTerm, $currentDate);
    $stmt->execute();
    $result = $stmt->get_result();
    $records = [];
    while ($row = $result->fetch_assoc()) {
        $records[] = $row;
    }
    $stmt->close();
}

// End new insert



function fetchRecords($conn, $search) {
    $searchTerm = '%' . $search . '%';
    $sql = $search ?
        "SELECT visitors.*, visit_reasons.reason_description, visiting_persons.person_name
        FROM visitors
        LEFT JOIN visit_reasons ON visitors.visit_reason_id = visit_reasons.reason_id
        LEFT JOIN visiting_persons ON visitors.visiting_person_id = visiting_persons.person_id
        WHERE CONCAT(visitors.first_name, ' ', visitors.last_name) LIKE ?"
        :
        "SELECT visitors.*, visit_reasons.reason_description, visiting_persons.person_name
        FROM visitors
        LEFT JOIN visit_reasons ON visitors.visit_reason_id = visit_reasons.reason_id
        LEFT JOIN visiting_persons ON visitors.visiting_person_id = visiting_persons.person_id";

    $stmt = $conn->prepare($sql);
    if ($search) {
        $stmt->bind_param("s", $searchTerm);
    }
    $stmt->execute();
    $result = $stmt->get_result();
    $records = [];
    while ($row = $result->fetch_assoc()) {
        $records[] = $row;
    }
    $stmt->close();
    return $records;
}

// Above Inesrted Code

// Handle Update/Delete/Check-in/Check-out requests
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $id = $_POST['id'] ?? null;

    if ($id && isset($_POST['delete'])) {
        $stmt = $conn->prepare("DELETE FROM visitors WHERE id = ?");
        $stmt->bind_param("i", $id);
        $stmt->execute();
        $stmt->close();
    } elseif ($id && isset($_POST['edit'])) {
        $stmt = $conn->prepare("SELECT visitors.*, visit_reasons.reason_description FROM visitors LEFT JOIN visit_reasons ON visitors.visit_reason_id = visit_reasons.reason_id WHERE visitors.id = ?");
        $stmt->bind_param("i", $id);
        $stmt->execute();
        $editRecord = $stmt->get_result()->fetch_assoc();
        $stmt->close();
    } elseif ($id && isset($_POST['save'])) {
        // Validate the "Reason for Visit" field
        if (empty($_POST['visit_reason_id']) || $_POST['visit_reason_id'] === "Select a reason") {
            $errorMessage = "Please select a reason for the visit.";
           // Redirect back to the edit form with an error message
            header("Location: edit.php?id=$id&error=" . urlencode($errorMessage));
            exit;
        } else {
            // Directly update the visitors table
            $stmt = $conn->prepare("UPDATE visitors SET first_name = ?, last_name = ?, visit_reason_id = ?, checkin_time = ?, checkout_time = ? WHERE id = ?");
            $stmt->bind_param("ssissi", $_POST['first_name'], $_POST['last_name'], $_POST['visit_reason_id'], $_POST['checkin_time'], $_POST['checkout_time'], $id);
            $stmt->execute();
            $stmt->close();
        }
    } elseif ($id && isset($_POST['checkin_now'])) {
        $current_time = date('Y-m-d H:i:s');
        $stmt = $conn->prepare("UPDATE visitors SET checkin_time = ? WHERE id = ?");
        $stmt->bind_param("si", $current_time, $id);
        $stmt->execute();
        $stmt->close();
    } elseif ($id && isset($_POST['checkout_now'])) {
        $current_time = date('Y-m-d H:i:s');
        $stmt = $conn->prepare("UPDATE visitors SET checkout_time = ? WHERE id = ?");
        $stmt->bind_param("si", $current_time, $id);
        $stmt->execute();
        $stmt->close();
    }
}

// Fetch pre-defined reasons from the database
$reasonsSql = "SELECT * FROM visit_reasons";
$reasonsResult = $conn->query($reasonsSql);

// Fetch records after processing POST requests
$records = fetchRecords($conn, $search);

$conn->close();
?>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visitor Reports</title>
    <link rel="stylesheet" type="text/css" href="../css/style.css">
</head>
<body>
    <h1>Visitor Reports</h1>
    <h2><a href="/admin/" class="button">Return to Admin Dashboard</a></h2>

    <!-- Search Form -->
    <form method="GET">
        <input type="text" name="search" placeholder="Search by Name, Reason, Person Visited" value="<?= htmlspecialchars($search) ?>">
        <input type="submit" value="Search">
    </form>

    <!-- Report Generation and CSV Download Form -->
    <form method="POST">
        <input type="submit" name="report_today" value="Get Today's Reports" class="button">
        <label for="month">Month:</label>
        <select id="month" name="month" class="select-style">
            <?php 
            $currentMonth = date('m');
            for ($i = 1; $i <= 12; $i++): ?>
                <option value="<?php echo $i; ?>" <?php echo $i == $currentMonth ? 'selected' : ''; ?>>
                    <?php echo date('F', mktime(0, 0, 0, $i, 10)); ?>
                </option>
            <?php endfor; ?>
        </select>
        <label for="year">Year:</label>
        <select id="year" name="year" class="select-style">
            <?php 
            $currentYear = date('Y');
            for ($i = $currentYear - 5; $i <= $currentYear; $i++): ?>
		<option value="<?php echo $i; ?>" <?php echo $i == $currentYear ? 'selected' : ''; ?>>
                    <?php echo $i; ?>
                </option>
            <?php endfor; ?>
        </select>
        <input type="submit" name="get_report" value="Get Monthly Report" class="button">
        <input type="submit" name="download_report" value="Download CSV" class="delete-button">
    </form>

// Inserting New Code


<!-- Report Table -->
<?php if (!empty($records)): ?>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Reason for Visit</th>
                <th>Person Visited</th>
                <th>Check-In Time</th>
                <th>Check-Out Time</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($records as $record): ?>
                <tr>
                    <td><?= htmlspecialchars($record['first_name']) . ' ' . htmlspecialchars($record['last_name']) ?></td>
                    <td><?= htmlspecialchars($record['reason_description']) ?></td>
                    <td><?= htmlspecialchars($record['person_name'] ?? 'N/A') ?></td>
                    <td><?= htmlspecialchars($record['checkin_time']) ?></td>
                    <td><?= htmlspecialchars($record['checkout_time']) ?></td>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
<?php else: ?>
    <p>No records to display.</p>

<!-- Report Table -->
<?php if (!empty($records)): ?>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Reason for Visit</th>
                <th>Person Visited</th>
                <th>Check-In Time</th>
                <th>Check-Out Time</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($records as $record): ?>
                <tr>
                    <td><?= htmlspecialchars($record['first_name']) . ' ' . htmlspecialchars($record['last_name']) ?></td>
                    <td><?= htmlspecialchars($record['reason_description']) ?></td>
                    <td><?= htmlspecialchars($record['person_name'] ?? 'N/A') ?></td>
                    <td><?= htmlspecialchars($record['checkin_time']) ?></td>
                    <td><?= htmlspecialchars($record['checkout_time']) ?></td>
                </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
<?php else: ?>
    <p>No records to display.</p>
<?php endif; ?>
<?php endif; ?>


</body>
</html>

